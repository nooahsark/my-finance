<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyFinance Dashboard V3.4 (Transactions Layout Update)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e3a8a', // Deep Blue
                        secondary: '#0d9488', // Teal
                        alert: '#f87171', // Soft Red
                        warning: '#f59e0b', // Amber/Orange
                        bg: '#F5F7FA',
                        card: '#FFFFFF',
                        accent: '#8b5cf6', // Violet
                    },
                    fontFamily: {
                        sans: ['Inter', 'Kanit', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Recharts -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #F5F7FA; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .recharts-tooltip-item, .recharts-tooltip-label { font-size: 13px !important; }
        .btn-hover { transition: all 0.2s ease; }
        .btn-hover:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .recharts-bar-cursor { fill: rgba(0,0,0,0.05); }
        .top-control { height: 42px; padding-top: 8px; padding-bottom: 8px; }
        .top-control-button { height: 42px; display: flex; align-items: center; }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col text-sm">
    
    <div id="root" class="flex-1 flex flex-col h-full overflow-hidden"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback, useRef } = React;
        const { LineChart, Line, BarChart, Bar, ComposedChart, PieChart, Pie, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, Legend } = window.Recharts;

        // --- Icons ---
        const Icons = {
            Wallet: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></svg>,
            TrendingUp: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
            List: ({size=20, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            Trash2: ({size=20, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Plus: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Scale: ({size=24, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>,
            Download: ({size=20, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Upload: ({size=20, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Settings: ({size=20, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Cloud: ({size=20, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M19 19H5"/><path d="M5.5 19c-1.41 0-2.74-.46-3.83-1.25a1 1 0 0 1-.07-1.57C3.34 14.63 5.76 13.5 8.5 13.5c1.65 0 3.16.41 4.45 1.12"/><path d="M18.5 19c1.41 0 2.74-.46 3.83-1.25a1 1 0 0 0 .07-1.57C20.66 14.63 18.24 13.5 15.5 13.5c-1.65 0-3.16.41-4.45 1.12"/><path d="M12 13.5V5"/><path d="m16 9-4-4-4 4"/></svg>,
            Check: ({size=20, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>,
            RefreshCw: ({size=20, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
        };

        // --- Config & Data ---
        const START_YEAR = 2016; 
        const INITIAL_END_YEAR = 2026;
        const STORAGE_KEY = 'my_finance_data_prod_v1'; 
        const STORAGE_KEY_TRADES = 'my_finance_trades_prod_v1';
        const STORAGE_KEY_BALANCES = 'my_finance_balances_prod_v1';
        const STORAGE_KEY_API_URL = 'my_finance_api_url_v1'; 

        const MONTHS = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
        const COLORS_MAIN = ['#1e3a8a', '#0d9488', '#0ea5e9', '#f59e0b', '#f87171', '#64748b', '#a8a29e', '#8b5cf6', '#ec4899'];
        
        const FORM_CATEGORIES = {
            income: ['เงินเดือน', 'วิทยฐานะ + ต.ข.ท.ปจต.', 'ดอกเบี้ย+เงินปันผล', 'รายได้อื่น ๆ'],
            expense: [ 'ค่าเช่า/ผ่อน บ้าน/คอนโด', 'ค่าผ่อนรถยนต์', 'ค่าเบี้ยประกัน', 'ค่าอาหาร', 'ค่าสาธารณูปโภค', 'ค่าเดินทาง', 'ค่าบริการ/นันทนาการ', 'ค่าช้อปปิ้ง', 'ค่าดูแล/รักษาสุขภาพ', 'เงินที่จ่ายให้กับพ่อแม่', 'ค่าอื่นๆ' ],
            savings: ['กบข.', 'เงินออม', 'เงินลงทุน']
        };

        // --- GLOBAL: Constants and Helpers ---
        const LIFE_INSURANCE_TABLE = { 2: 800, 3: 2800, 4: 4800, 5: 6800, 6: 9200, 7: 12000, 8: 14400, 9: 17000, 10: 19800, 11: 22600, 12: 25600, 13: 28800, 14: 32000, 15: 35600, 16: 39200, 17: 43200, 18: 47200, 19: 51600, 20: 56200, 21: 58000, 22: 60000, 23: 62000, 24: 64000, 25: 66000, 26: 68200, 27: 70200, 28: 72600, 29: 74800, 30: 77000, 31: 79400, 32: 81800, 33: 84400, 34: 87000, 35: 89600, 36: 92200, 37: 94800, 38: 97600, 39: 100200, 40: 103000, 41: 105600, 42: 108200, 43: 110800, 44: 113400, 45: 116000, 46: 118600, 47: 121000, 48: 123600, 49: 126200, 50: 128600, 51: 131200, 52: 133800, 53: 136200, 54: 138800, 55: 141400, 56: 144000, 57: 146400, 58: 148800, 59: 151200, 60: 153400, 61: 155600, 62: 157800, 63: 159800, 64: 161800, 65: 163600, 66: 165600, 67: 167400, 68: 169000, 69: 170800, 70: 172400, 71: 174200, 72: 176000, 73: 178200, 74: 181000, 75: 184800, 76: 190400, 77: 200000 };

        // REMOVED MID_EXP SPLIT LOGIC
        const TRANSACTION_CATEGORIES = [
            { label: 'รายได้', items: FORM_CATEGORIES.income, color: 'emerald', iconColor: 'bg-emerald-500', borderColor: 'border-emerald-100' },
            { label: 'ค่าใช้จ่าย', items: FORM_CATEGORIES.expense, color: 'rose', iconColor: 'bg-rose-500', borderColor: 'border-rose-100' }, 
            { label: 'เงินออม', items: FORM_CATEGORIES.savings, color: 'purple', iconColor: 'bg-purple-500', borderColor: 'border-purple-100' }
        ];

        const ASSET_TYPES = [
            { id: 'gpf', label: 'กบข.' }, { id: 'mutual_fund', label: 'กองทุนรวม' }, { id: 'stock', label: 'หุ้นสามัญ/ETF' }, { id: 'bond', label: 'ตราสารหนี้/พันธบัตร' }, { id: 'gold', label: 'ทองคำ' }
        ];
        const ASSET_TYPE_LABELS = { gpf: 'กบข.', mutual_fund: 'กองทุนรวม', stock: 'หุ้น/ETF', bond: 'ตราสารหนี้', gold: 'ทองคำ', land: 'อสังหาฯ', ins: 'ประกันชีวิต', ss: 'ประกันสังคม' };
        
        const formatNumber = (val, digits=0) => new Intl.NumberFormat('th-TH', { minimumFractionDigits: digits, maximumFractionDigits: digits }).format(val);
        const formatCurrency = (val) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits: 2 }).format(val);
        const calculateXIRR = (cashFlows, guess = 0.1) => { if (cashFlows.length < 2) return 0; const maxIterations = 50; const tolerance = 1e-6; let x0 = guess; for (let i = 0; i < maxIterations; i++) { let fValue = 0, fDerivative = 0; for (const { amount, date } of cashFlows) { const days = (date - cashFlows[0].date) / (1000 * 60 * 60 * 24); const years = days / 365; const factor = Math.pow(1 + x0, years); fValue += amount / factor; fDerivative -= (years * amount) / (factor * (1 + x0)); } if (Math.abs(fValue) < tolerance) return x0 * 100; const x1 = x0 - fValue / fDerivative; if (Math.abs(x1 - x0) < tolerance) return x1 * 100; x0 = x1; } return x0 * 100; };
        const calculateLifeInsuranceValue = (queryDate) => { const startDate = new Date(2014, 1, 7); if (queryDate < startDate) return 0; let years = queryDate.getFullYear() - startDate.getFullYear(); const m = queryDate.getMonth() - startDate.getMonth(); if (m < 0 || (m === 0 && queryDate.getDate() < startDate.getDate())) { years--; } const policyYear = years + 1; if (policyYear >= 77) return 200000; return LIFE_INSURANCE_TABLE[policyYear] || 0; };
        const cleanNumericInput = (val) => { let cleanVal = val.replace(/[^\d.]/g, ''); const parts = cleanVal.split('.'); if (parts.length > 2) { cleanVal = parts[0] + '.' + parts.slice(1).join(''); } return cleanVal; };
        const getTodayString = () => { const d = new Date(); const year = d.getFullYear(); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; };

        // --- Mock Data Generators (EMPTY for User to Fill) ---
        const generateDetailedHistoricalData = () => { 
            const data = []; 
            const allCats = [...FORM_CATEGORIES.income, ...FORM_CATEGORIES.expense, ...FORM_CATEGORIES.savings];
            for (let y = START_YEAR; y <= INITIAL_END_YEAR + 5; y++) { 
                for (let m = 0; m < 12; m++) { 
                    const details = {};
                    allCats.forEach(c => details[c] = 0);
                    data.push({ id: `${y}-${m}`, dateObj: new Date(y, m, 1), year: y, monthIndex: m, income: 0, expense: 0, savings: 0, details: details, axisLabel: `${MONTHS[m].substr(0,3)} ${String(y+543).substr(2)}` }); 
                } 
            } 
            return data; 
        };
        const generateMockTrades = () => { return []; };
        const generateMockSnapshots = () => { return {}; };

        const Card = ({ children, className = "" }) => <div className={`bg-white rounded-2xl shadow-sm border border-slate-100 p-5 ${className}`}>{children}</div>;

        // --- View Components ---

        const DashboardView = ({ combinedAssetsData, graphData, top5Exp, overviewCalc, getAnnRet, renderAssetList, renderExpenseList, cards, cashFlowData, setCashFlowRange, cashFlowRange, combinedGraphData, currentIRR }) => (
            <div className="flex flex-col gap-4 h-full p-4 lg:p-6 overflow-y-auto lg:overflow-hidden no-scrollbar">
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 shrink-0">
                    {cards.map((c,i)=>(<Card key={i} className={`flex flex-row items-center justify-between py-3 border-l-4 ${c.b}`}><span className="text-sm text-slate-400 font-medium">{c.label}</span><span className={`text-xl font-bold ${c.color}`}>{formatNumber(c.val)}</span></Card>))}
                </div>
                
                {/* Desktop: Equal height split. Mobile: Stacked with min-height */}
                <div className="flex flex-col lg:flex-row gap-3 lg:gap-4 flex-1 min-h-[300px] lg:min-h-0 lg:basis-0">
                    {/* Left Col: Asset Pie & List */}
                    <Card className="w-full lg:w-[40%] flex flex-col lg:flex-row items-center h-[300px] lg:h-auto lg:flex-1">
                        <div className="w-full lg:w-[45%] h-full relative">
                            <h3 className="font-bold text-slate-700 mb-2 absolute top-0 left-0 text-base">สัดส่วนสินทรัพย์รวม</h3>
                            <ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={combinedAssetsData} innerRadius={40} outerRadius={80} paddingAngle={2} dataKey="value" cx="50%" cy="55%">{combinedAssetsData.map((e,i)=><Cell key={i} fill={COLORS_MAIN[i%COLORS_MAIN.length]}/>)}</Pie><Tooltip formatter={v=>formatNumber(v)}/></PieChart></ResponsiveContainer>
                        </div>
                        <div className="w-full lg:w-[55%] mt-2 lg:mt-0 h-full overflow-y-auto no-scrollbar">{renderAssetList}</div>
                    </Card>

                    {/* Right Col: Performance Graph */}
                    <Card className="w-full lg:w-[60%] flex flex-col h-[300px] lg:h-auto lg:flex-1 relative">
                        <div className="flex justify-between items-start mb-1 shrink-0">
                            <h3 className="font-bold text-slate-700">% ผลการดำเนินงาน</h3>
                            <div className="text-right">
                                <span className="text-[10px] text-slate-500 font-medium block leading-none">IRR (Annualized)</span>
                                <span className="text-sm font-extrabold text-primary">{currentIRR.toFixed(2)}%</span>
                            </div>
                        </div>
                        <div className="flex-1 min-h-0">
                            <ResponsiveContainer>
                                <LineChart data={combinedGraphData}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0"/>
                                    <XAxis dataKey="date" tick={{fontSize:10}}/>
                                    <YAxis domain={['auto', 'auto']} tick={{fontSize:10}} tickFormatter={v=>`${(v/1e6).toFixed(1)}M`}/>
                                    <Tooltip formatter={(v, n, p) => formatNumber(v)}/>
                                    <Line type="monotone" dataKey="val" name="มูลค่าสินทรัพย์รวม" stroke="#1e3a8a" strokeWidth={3} dot={false}/>
                                    <Line type="monotone" dataKey="benchmarkVal" name="Benchmark (NAV)" stroke="#f59e0b" strokeWidth={2} dot={false} strokeDasharray="5 5" />
                                    <Legend wrapperStyle={{fontSize: 10, padding: '5px 0 0 0'}} />
                                </LineChart>
                            </ResponsiveContainer>
                        </div>
                        <div className="grid grid-cols-5 gap-1 mt-1 pt-1 border-t border-slate-100 text-center shrink-0">
                            {[1,3,5,10].map(y=><div key={y}><span className="text-[9px] text-slate-400 font-bold block">{y} ปี</span><span className={`text-[10px] font-bold ${getAnnRet(y)>=0?'text-secondary':'text-alert'}`}>{getAnnRet(y).toFixed(2)}%</span></div>)}
                            <div><span className="text-[9px] text-slate-400 font-bold block">ตั้งแต่จัดตั้ง</span><span className="text-[10px] font-bold text-primary">{(combinedGraphData.length>0 ? ((combinedGraphData[combinedGraphData.length-1].val - combinedGraphData[0].val)/combinedGraphData[0].val)*100 : 0).toFixed(2)}%</span></div>
                        </div>
                    </Card>
                </div>

                <div className="flex flex-col lg:flex-row gap-3 lg:gap-4 flex-1 min-h-0">
                    {/* Left Col: Cashflow */}
                    <Card className="w-full lg:w-[60%] flex flex-col relative h-[300px] lg:h-auto lg:flex-1">
                        <div className="flex justify-between items-center mb-1 shrink-0"><h3 className="font-bold text-slate-700">กระแสเงินสด (รายได้ vs ค่าใช้จ่าย)</h3><div className="flex gap-1 bg-slate-100 rounded p-0.5 z-10">{[1,3,5].map(y=><button key={y} onClick={()=>setCashFlowRange(y)} className={`px-2 py-0.5 text-[10px] rounded font-bold transition-all ${cashFlowRange===y?'bg-white shadow text-primary':'text-slate-500'}`}>{y}Y</button>)}</div></div>
                        <div className="flex-1 min-h-0"><ResponsiveContainer><ComposedChart data={cashFlowData}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0"/><XAxis dataKey="name" tick={{fontSize:10}}/><YAxis tick={{fontSize:10}} tickFormatter={v=>`${(v/1000).toFixed(0)}k`}/><Tooltip formatter={v=>formatNumber(v)}/><Bar dataKey="income" fill="#0d9488" radius={[4,4,0,0]} barSize={20}/><Line type="monotone" dataKey="expense" stroke="#f87171" strokeWidth={2}/></ComposedChart></ResponsiveContainer></div>
                    </Card>
                    {/* Right Col: Expense Pie */}
                    <Card className="w-full lg:w-[40%] flex flex-col lg:flex-row items-center h-[300px] lg:h-auto lg:flex-1">
                        <div className="w-full lg:w-[45%] h-full relative">
                            <h3 className="font-bold text-slate-700 mb-2 absolute top-0 left-0 text-base">สัดส่วนค่าใช้จ่าย</h3>
                            <ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={top5Exp} innerRadius={40} outerRadius={80} paddingAngle={2} dataKey="value" cx="50%" cy="55%">{top5Exp.map((e,i)=><Cell key={i} fill={COLORS_MAIN[i%COLORS_MAIN.length]}/>)}</Pie><Tooltip formatter={v=>formatNumber(v)}/></PieChart></ResponsiveContainer>
                        </div>
                        <div className="w-full lg:w-[55%] h-full overflow-y-auto no-scrollbar">{renderExpenseList}</div>
                    </Card>
                </div>
            </div>
        );

        const TransactionsView = ({ formData, handleBudgetInput, saveBudgetToHistory, getBudgetAvg, budgetAvgRange, setBudgetAvgRange, allCategories, totalInc, totalExp, totalSav, net }) => {
            // Stats Data for Top Cards
            const transCards = [ 
                { label: 'รายได้รวม', val: totalInc, color: 'text-secondary', b: 'border-secondary' }, 
                { label: 'ค่าใช้จ่ายรวม', val: totalExp, color: 'text-alert', b: 'border-alert' }, 
                { label: 'เงินออมรวม', val: totalSav, color: 'text-purple-600', b: 'border-purple-600' }, 
                { label: 'คงเหลือสุทธิ', val: net, color: 'text-primary', b: 'border-primary' } 
            ];

            return (
                <div className="h-full flex flex-col p-4 lg:p-6 gap-4 overflow-hidden">
                    {/* NEW: Top Summary Cards (Same style as Dashboard) */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 shrink-0">
                        {transCards.map((c,i)=>(
                            <Card key={i} className={`flex flex-row items-center justify-between py-3 border-l-4 ${c.b}`}>
                                <span className="text-sm text-slate-400 font-medium">{c.label}</span>
                                <span className={`text-xl font-bold ${c.color}`}>{formatNumber(c.val)}</span>
                            </Card>
                        ))}
                    </div>

                    <Card className="flex-1 overflow-hidden relative border-t-4 border-t-primary flex flex-col h-full min-h-0">
                        {/* Header with Title only */}
                        <div className="flex flex-col gap-2 mb-2 border-b border-slate-100 pb-2 shrink-0 bg-white sticky top-0 z-10 p-2">
                            <div className="flex justify-between items-center">
                                <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Icons.List size={24} className="text-primary"/> บันทึกรายการ</h2>
                                <div className="flex gap-1 bg-slate-100 rounded p-1 w-fit">{[1,3,5].map(y=><button key={y} onClick={()=>setBudgetAvgRange(y)} className={`px-4 py-1 text-xs font-bold rounded ${budgetAvgRange===y?'bg-white shadow text-primary':'text-slate-500'}`}>{y}Y Avg</button>)}</div>
                            </div>
                        </div>
                        
                        {/* Input Grid */}
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 flex-1 overflow-y-auto no-scrollbar content-start p-1">
                             {TRANSACTION_CATEGORIES.flatMap(({ label, items, color, iconColor, borderColor }) => [
                                <div key={`header-${label}`} className="col-span-1 sm:col-span-2 lg:col-span-4 shrink-0 mt-1 first:mt-0">
                                     <h4 className={`text-${color}-600 font-bold flex items-center gap-1.5 border-b ${borderColor} pb-0.5 text-xs uppercase tracking-wider`}>
                                        <div className={`w-2 h-2 rounded-full ${iconColor}`}></div>{label}
                                    </h4>
                                </div>,
                                ...items.map(it => (
                                    <div key={it} className="flex flex-col justify-center bg-slate-50 px-3 py-1.5 rounded border border-slate-100 shadow-sm h-fit col-span-1">
                                        <div className="flex justify-between items-center gap-2">
                                            <label className="text-slate-700 truncate text-sm font-semibold flex-1">{it}</label>
                                            <input 
                                                type="text" 
                                                value={formData[it] || ''} 
                                                onChange={e => handleBudgetInput(it, e.target.value)} 
                                                onBlur={saveBudgetToHistory}
                                                className="w-24 bg-white border rounded px-2 h-7 text-right text-sm font-bold text-slate-800 outline-none focus:ring-1 focus:ring-primary placeholder-slate-300" 
                                                placeholder="0"
                                            />
                                        </div>
                                        <div className="text-right text-[10px] text-slate-500 leading-tight mt-1">avg: {formatNumber(getBudgetAvg(it, budgetAvgRange))}</div>
                                    </div>
                                ))
                             ])}
                        </div>
                    </Card>
                </div>
            );
        };

        const PortfolioView = ({ tradeForm, handleTradeChange, activeSymbols, totalPortValue, trades, ASSET_TYPES, ASSET_TYPE_LABELS, addTrade, deleteTrade, sellAll }) => (
            <div className="h-full flex flex-col p-4 lg:p-6 gap-6 overflow-hidden">
                <Card className="shrink-0 flex justify-between items-center py-6 bg-slate-900 text-white border-none shadow-lg">
                    <div className="flex flex-col"><span className="text-slate-400 text-sm font-medium">มูลค่าพอร์ตลงทุนปัจจุบัน (Estimated)</span><span className="text-4xl font-bold tracking-tight text-emerald-400">{formatNumber(totalPortValue)}</span></div>
                    <div className="flex gap-4"><div className="text-right"><span className="block text-xs text-slate-500">จำนวนหลักทรัพย์</span><span className="text-xl font-bold">{activeSymbols.length}</span></div></div>
                </Card>
                <div className="flex flex-col gap-6 flex-1 overflow-hidden">
                    <Card className="shrink-0 flex flex-col gap-4 border-l-4 border-l-secondary bg-slate-50">
                        <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Icons.List size={20}/> ทำรายการ (Action)</h3>
                        <div className="grid grid-cols-2 lg:grid-cols-8 gap-3 items-end">
                            <div className="col-span-1"><label className="text-xs text-slate-500 block mb-1">วันที่</label><input type="date" value={tradeForm.date} onChange={e=>handleTradeChange('date',e.target.value)} className="border rounded-lg p-2 w-full text-sm outline-none focus:border-primary"/></div>
                            <div className="col-span-1"><label className="text-xs text-slate-500 block mb-1">Symbol</label><input type="text" placeholder="SCB" value={tradeForm.symbol} onChange={e=>handleTradeChange('symbol',e.target.value.toUpperCase())} className="border rounded-lg p-2 w-full text-sm font-bold uppercase text-primary outline-none focus:border-primary"/></div>
                            <div className="col-span-1"><label className="text-xs text-slate-500 block mb-1">ประเภท</label><select value={tradeForm.assetType} onChange={e=>handleTradeChange('assetType',e.target.value)} className="border rounded-lg p-2 w-full text-sm outline-none focus:border-primary h-[42px]">{ASSET_TYPES.map(t=><option key={t.id} value={t.id}>{t.label}</option>)}</select></div>
                            <div className="col-span-1"><label className="text-xs text-slate-500 block mb-1">จำนวน</label><input type="text" placeholder="0.0000" value={tradeForm.amount} onChange={e=>handleTradeChange('amount',e.target.value)} className="border rounded-lg p-2 w-full text-sm text-right outline-none focus:border-primary"/></div>
                            <div className="col-span-1"><label className="text-xs text-slate-500 block mb-1">ราคา</label><input type="text" placeholder="0.0000" value={tradeForm.price} onChange={e=>handleTradeChange('price',e.target.value)} className="border rounded-lg p-2 w-full text-sm text-right outline-none focus:border-primary"/></div>
                            <div className="col-span-1"><label className="text-xs text-slate-500 block mb-1">รวม</label><input type="text" placeholder="0.00" value={tradeForm.total} onChange={e=>handleTradeChange('total',e.target.value)} className="border rounded-lg p-2 w-full text-sm text-right font-bold text-primary outline-none focus:border-primary"/></div>
                            <div className="col-span-2 flex gap-2">
                                <button onClick={()=>handleTradeChange('type','buy')} className={`flex-1 py-2 rounded-lg font-bold text-white shadow btn-hover ${tradeForm.type==='buy'?'bg-secondary':'bg-slate-300'}`}>ซื้อ</button>
                                <button onClick={()=>handleTradeChange('type','sell')} className={`flex-1 py-2 rounded-lg font-bold text-white shadow btn-hover ${tradeForm.type==='sell'?'bg-alert':'bg-slate-300'}`}>ขาย</button>
                                <button onClick={sellAll} className="flex-1 py-2 rounded-lg font-bold text-white shadow btn-hover bg-orange-500">ขายหมด</button>
                                <button onClick={addTrade} className="flex-[2] bg-primary text-white py-2 rounded-lg font-bold shadow-md btn-hover">บันทึก</button>
                            </div>
                        </div>
                    </Card>
                    <Card className="flex-1 flex flex-col gap-2 overflow-hidden">
                        <h3 className="font-bold text-lg text-slate-800">ประวัติการทำรายการ</h3>
                        <div className="flex-1 overflow-x-auto">
                            <table className="w-full text-sm text-left border-collapse min-w-[600px]">
                                <thead className="bg-slate-50 sticky top-0 text-slate-500 font-semibold"><tr><th className="p-3 rounded-tl-lg">วันที่</th><th>รายการ</th><th>ประเภท</th><th className="text-right">จำนวน</th><th className="text-right">ราคา</th><th className="text-right pr-3 rounded-tr-lg">รวม</th><th className="w-10"></th></tr></thead>
                                <tbody className="divide-y divide-slate-100 font-sans">
                                    {trades.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t=>(
                                        <tr key={t.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="p-3">{new Date(t.date).toLocaleDateString('th-TH')}</td>
                                            <td className="font-bold"><span className={`px-2 py-0.5 rounded text-xs mr-2 text-white ${t.type==='buy'?'bg-secondary':t.type==='sell'?'bg-alert':t.type==='sell_all'?'bg-orange-500':'bg-blue-400'}`}>{t.type === 'sell_all' ? 'SELL ALL' : t.type.toUpperCase()}</span>{t.symbol}</td>
                                            <td><span className="text-slate-500">{ASSET_TYPE_LABELS[t.assetType] || t.assetType}</span></td>
                                            <td className="text-right">{formatNumber(t.amount, 4)}</td>
                                            <td className="text-right">{formatNumber(t.price, 4)}</td>
                                            <td className="text-right font-bold text-slate-700 pr-3">{formatNumber(t.total, 2)}</td>
                                            <td className="text-center"><button onClick={()=>deleteTrade(t.id)} className="text-slate-300 hover:text-red-500"><Icons.Trash2 size={16}/></button></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                </div>
            </div>
        );

        const BalanceSheetView = ({ currentSnapshot, handleSnap, balanceDate, setBalanceDate, saveSnapshot, holdings, grouped, calculateLifeInsuranceValue, getHoldings, getCurrentSnapValue, overviewCalc }) => {
            const condoStartDate = new Date('2023-12-01');
            const showCondo = new Date(balanceDate) >= condoStartDate;
            return (
                <div className="h-full flex flex-col p-4 lg:p-6 gap-6 overflow-hidden">
                    <Card className="shrink-0 flex flex-col lg:flex-row justify-between items-center py-4 bg-slate-50 border-b-2 border-primary gap-4">
                        <h2 className="text-xl font-bold text-primary flex items-center gap-2"><Icons.Scale/> ประเมินมูลค่าสินทรัพย์</h2>
                        <div className="flex gap-3 items-center w-full lg:w-auto">
                            <input type="text" placeholder="Benchmark NAV" value={getCurrentSnapValue('benchmarkNav')} onChange={e=>handleSnap('benchmarkNav',e.target.value)} className="border border-indigo-200 rounded p-1.5 w-32 text-right bg-white text-indigo-700 font-bold shadow-sm placeholder-slate-300 text-xs flex-1 lg:flex-none"/>
                            <input type="date" value={balanceDate} onChange={e=>setBalanceDate(e.target.value)} className="border rounded-lg p-2 font-bold text-slate-700 flex-1 lg:flex-none"/>
                            <button onClick={saveSnapshot} className="bg-primary text-white px-6 py-2 rounded-lg font-bold shadow btn-hover flex-1 lg:flex-none">บันทึก</button>
                        </div>
                    </Card>
                    <div className="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-y-auto pb-20">
                        <div className="flex flex-col gap-4">
                            <div className="border rounded-xl p-4 bg-white border-slate-200 shadow-sm border-l-4 border-l-secondary">
                                <h4 className="font-bold text-lg text-secondary mb-4 pb-2 border-b border-slate-100 flex items-center gap-2">สินทรัพย์ลงทุน (หน่วยลงทุน)</h4>
                                <div className="flex flex-col gap-6">
                                    {[ {k:'gpf', l:'กบข.'}, {k:'mutual_fund', l:'กองทุนรวม'}, {k:'stock', l:'หุ้น/ETF'}, {k:'bond', l:'ตราสารหนี้'} ].map(grp => (
                                        <div key={grp.k} className="flex flex-col gap-2">
                                            <div className="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded w-fit">{grp.l}</div>
                                            {grouped[grp.k].map(sym => (
                                                <div key={sym} className="grid grid-cols-3 gap-2 items-center text-xs pl-2 bg-slate-50 p-2 rounded">
                                                    <div className="font-bold text-slate-700 truncate text-sm">{sym} <span className="text-[10px] font-normal text-slate-400">({formatNumber(holdings[sym].qty, (grp.k==='stock'?0:2))})</span></div>
                                                    <input type="text" value={getCurrentSnapValue('prices', sym)} onChange={e=>handleSnap('prices',e.target.value,sym)} className="border rounded p-1 text-right text-slate-600 placeholder-slate-300 bg-white text-xs w-24" placeholder="ราคา"/>
                                                    <div className="text-right font-bold text-secondary text-sm">{formatNumber((parseFloat(getCurrentSnapValue('prices', sym))||0)*holdings[sym].qty)}</div>
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div className="flex flex-col gap-4">
                            <div className="border rounded-xl p-3 bg-white border-slate-200 shadow-sm border-l-4 border-l-blue-500">
                                <h4 className="font-bold text-sm text-blue-500 mb-3 uppercase tracking-wider border-b pb-1">สินทรัพย์สภาพคล่อง</h4>
                                <div className="flex justify-between items-center text-xs"><span className="text-slate-600 text-sm">เงินสด</span><input type="text" value={getCurrentSnapValue('cash')} onChange={e=>handleSnap('cash',e.target.value)} className="border rounded p-1 text-right font-bold w-24 text-sm text-slate-700" placeholder="มูลค่ารวม"/></div>
                            </div>
                            <div className="border rounded-xl p-3 bg-white border-slate-200 shadow-sm border-l-4 border-l-cyan-500">
                                <h4 className="font-bold text-sm text-cyan-500 mb-3 uppercase tracking-wider border-b pb-1">สินทรัพย์ส่วนตัว</h4>
                                {showCondo ? (
                                    <div className="flex justify-between items-center text-xs"><span className="text-slate-600 text-sm">ห้องชุด (33.36 ตร.ม.)</span><div className="flex gap-2 items-center"><input type="text" value={getCurrentSnapValue('condoPriceSqm')} onChange={e=>handleSnap('condoPriceSqm',e.target.value)} className="w-20 border rounded p-1 text-right text-xs" placeholder="ราคา/ตร.ม."/><span className="w-24 text-right font-bold text-cyan-700 text-sm">{formatNumber((parseFloat(getCurrentSnapValue('condoPriceSqm'))||0)*33.36)}</span></div></div>
                                ) : (<div className="text-center text-slate-400 text-xs py-2 italic">ยังไม่มีรายการนี้</div>)}
                            </div>
                            <div className="border rounded-xl p-3 bg-white border-slate-200 shadow-sm border-l-4 border-l-amber-500">
                                <h4 className="font-bold text-sm text-amber-500 mb-3 uppercase tracking-wider border-b pb-1">สินทรัพย์ลงทุนอื่นๆ</h4>
                                <div className="flex flex-col gap-2">
                                    <div className="flex justify-between items-center text-xs"><span className="text-slate-600 text-sm">ประกันสังคม</span><span className="font-bold w-24 text-right text-sm text-slate-700">{formatNumber(12600)}</span></div>
                                    <div className="flex justify-between items-center text-xs"><span className="text-slate-600 text-sm">ประกันชีวิต</span><span className="font-bold w-24 text-right text-sm text-indigo-600">{formatNumber(calculateLifeInsuranceValue(new Date(balanceDate)))}</span></div>
                                    <div className="flex justify-between items-center text-xs"><span className="text-slate-600 text-sm">ทองคำ</span><div className="flex gap-2 items-center"><input type="text" placeholder="ราคา/บาท" value={getCurrentSnapValue('goldPrice')} onChange={e=>handleSnap('goldPrice',e.target.value)} className="w-20 border rounded p-1 text-right text-xs" /><span className="w-24 text-right font-bold text-amber-600 text-sm">{formatNumber((parseFloat(getCurrentSnapValue('goldPrice'))||0)*(getHoldings(balanceDate)['ทองคำ']?.qty||0))}</span></div></div>
                                    <div className="flex justify-between items-center text-xs"><span className="text-slate-600 text-sm">ที่ดิน จ.ลำปาง</span><div className="flex gap-2 items-center"><input type="text" placeholder="ราคา/ตร.วา" value={getCurrentSnapValue('landPrice')} onChange={e=>handleSnap('landPrice',e.target.value)} className="w-20 border rounded p-1 text-right text-xs" placeholder="ราคา/ตร.วา" /><span className="w-24 text-right font-bold text-amber-600 text-sm">{formatNumber((parseFloat(getCurrentSnapValue('landPrice'))||0)*1130)}</span></div></div>
                                </div>
                            </div>
                        </div>
                        <div className="flex flex-col gap-4">
                            <div className="border rounded-xl p-3 bg-white border-slate-200 shadow-sm border-l-4 border-l-alert">
                                <h4 className="font-bold text-sm text-alert mb-3 uppercase tracking-wider border-b pb-1">หนี้สินระยะสั้น</h4>
                                <div className="flex justify-between items-center text-xs"><span className="text-slate-600 text-sm">หนี้บัตรเครดิต</span><input type="text" value={getCurrentSnapValue('creditCardDebt')} onChange={e=>handleSnap('creditCardDebt',e.target.value)} className="border rounded p-1 text-right font-bold w-24 text-sm text-alert" placeholder="มูลค่ารวม"/></div>
                            </div>
                            <div className="border rounded-xl p-3 bg-white border-slate-200 shadow-sm border-l-4 border-l-red-800">
                                <h4 className="font-bold text-sm text-red-800 mb-3 uppercase tracking-wider border-b pb-1">หนี้สินระยะยาว</h4>
                                {showCondo ? (
                                    <div className="flex justify-between items-center text-xs"><span className="text-slate-600 text-sm">เงินกู้ซื้อห้องชุด</span><input type="text" value={getCurrentSnapValue('condoLoanDebt')} onChange={e=>handleSnap('condoLoanDebt',e.target.value)} className="border rounded p-1 text-right font-bold w-24 text-sm text-red-800" placeholder="มูลค่ารวม"/></div>
                                ) : (<div className="text-center text-slate-400 text-xs py-2 italic">ยังไม่มีรายการนี้</div>)}
                            </div>
                        </div>
                    </div>
                    <div className="fixed bottom-0 lg:bottom-6 left-0 lg:left-6 right-0 lg:right-6 bg-slate-900 text-white p-4 lg:rounded-xl shadow-2xl flex flex-col lg:flex-row justify-between items-center px-6 lg:px-10 z-50 gap-4 lg:gap-0">
                        <div className="flex gap-4 lg:gap-8 w-full lg:w-auto justify-between lg:justify-start">
                            <div className="flex flex-col"><span className="text-[10px] lg:text-xs text-slate-400 uppercase">สินทรัพย์รวม</span><span className="text-xl lg:text-2xl font-bold text-secondary">{formatNumber(overviewCalc.totalAssets)}</span></div>
                            <div className="h-auto w-px bg-slate-700"></div>
                            <div className="flex flex-col"><span className="text-[10px] lg:text-xs text-slate-400 uppercase">หนี้สินรวม</span><span className="text-xl lg:text-2xl font-bold text-alert">{formatNumber(overviewCalc.totalLiab)}</span></div>
                        </div>
                        <div className="flex items-center gap-4 w-full lg:w-auto justify-between lg:justify-end">
                            <span className="text-xl font-light text-slate-400 hidden lg:block">=</span>
                            <div className="flex flex-col items-end"><span className="text-[10px] lg:text-xs text-slate-400 uppercase">ความมั่งคั่งสุทธิ</span><span className="text-2xl lg:text-3xl font-extrabold text-white">{formatNumber(overviewCalc.totalAssets - overviewCalc.totalLiab)}</span></div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        function FinanceDashboard() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [selectedYear, setSelectedYear] = useState(2025);
            const [selectedMonthIndex, setSelectedMonthIndex] = useState(new Date().getMonth());
            const [maxYear, setMaxYear] = useState(INITIAL_END_YEAR);
            const [cashFlowRange, setCashFlowRange] = useState(1);
            
            // App state
            const [formData, setFormData] = useState({});
            const [historicalData, setHistoricalData] = useState(() => { const s = localStorage.getItem(STORAGE_KEY); return s ? JSON.parse(s).map(d => ({...d, dateObj: new Date(d.dateObj)})) : generateDetailedHistoricalData(); });
            const [trades, setTrades] = useState(() => { const s = localStorage.getItem(STORAGE_KEY_TRADES); return (s && JSON.parse(s).length > 0) ? JSON.parse(s) : generateMockTrades(); });
            
            const [balanceSnapshots, setBalanceSnapshots] = useState(() => { 
                const s = localStorage.getItem(STORAGE_KEY_BALANCES); 
                const snaps = (s && Object.keys(JSON.parse(s)).length > 0) ? JSON.parse(s) : generateMockSnapshots();
                const stringifiedSnaps = {};
                for (const date in snaps) {
                    const snap = snaps[date];
                    const newSnap = {};
                    for (const key in snap) {
                        if (typeof snap[key] === 'number' || typeof snap[key] === 'string') { newSnap[key] = String(snap[key]); }
                        else if (key === 'prices' && snap.prices) { newSnap.prices = Object.keys(snap.prices).reduce((acc, sym) => { acc[sym] = String(snap.prices[sym]); return acc; }, {}); }
                        else { newSnap[key] = snap[key]; }
                    }
                    stringifiedSnaps[date] = newSnap;
                }
                return stringifiedSnaps;
            }); 
            
            const [tradeForm, setTradeForm] = useState(() => ({ date: getTodayString(), type: 'buy', symbol: '', assetType: 'mutual_fund', amount: '', price: '', total: '' }));
            const [balanceDate, setBalanceDate] = useState(getTodayString());
            const [currentSnapshot, setCurrentSnapshot] = useState({});
            const [budgetAvgRange, setBudgetAvgRange] = useState(1);
            
            // Sync/Settings state
            const [apiUrl, setApiUrl] = useState(() => localStorage.getItem(STORAGE_KEY_API_URL) || '');
            const [syncStatus, setSyncStatus] = useState('offline'); // offline, syncing, synced, error
            const fileInputRef = useRef(null);

            useEffect(() => localStorage.setItem(STORAGE_KEY, JSON.stringify(historicalData)), [historicalData]);
            useEffect(() => localStorage.setItem(STORAGE_KEY_TRADES, JSON.stringify(trades)), [trades]);
            useEffect(() => localStorage.setItem(STORAGE_KEY_BALANCES, JSON.stringify(balanceSnapshots)), [balanceSnapshots]);
            useEffect(() => localStorage.setItem(STORAGE_KEY_API_URL, apiUrl), [apiUrl]);

            // --- API / Cloud Sync Logic ---
            useEffect(() => {
                if (apiUrl) {
                    setSyncStatus('syncing');
                    fetch(`${apiUrl}?action=load`)
                        .then(res => res.json())
                        .then(res => {
                            if (res.status === 'success') {
                                const data = res.data;
                                if (data[STORAGE_KEY]) setHistoricalData(JSON.parse(data[STORAGE_KEY]).map(d => ({...d, dateObj: new Date(d.dateObj)})));
                                if (data[STORAGE_KEY_TRADES]) setTrades(JSON.parse(data[STORAGE_KEY_TRADES]));
                                if (data[STORAGE_KEY_BALANCES]) setBalanceSnapshots(JSON.parse(data[STORAGE_KEY_BALANCES]));
                                setSyncStatus('synced');
                            } else {
                                setSyncStatus('error');
                            }
                        })
                        .catch(() => setSyncStatus('error'));
                }
            }, [apiUrl]);

            useEffect(() => {
                if (!apiUrl) return;
                const timeoutId = setTimeout(() => {
                    setSyncStatus('syncing');
                    const payload = {
                        key: STORAGE_KEY, 
                    };
                    Promise.all([
                        fetch(apiUrl, { method: 'POST', body: JSON.stringify({ key: STORAGE_KEY, value: JSON.stringify(historicalData) }) }),
                        fetch(apiUrl, { method: 'POST', body: JSON.stringify({ key: STORAGE_KEY_TRADES, value: JSON.stringify(trades) }) }),
                        fetch(apiUrl, { method: 'POST', body: JSON.stringify({ key: STORAGE_KEY_BALANCES, value: JSON.stringify(balanceSnapshots) }) })
                    ]).then(() => setSyncStatus('synced'))
                      .catch(() => setSyncStatus('error'));

                }, 2000); 
                return () => clearTimeout(timeoutId);
            }, [historicalData, trades, balanceSnapshots, apiUrl]);


            useEffect(() => { 
                const r = historicalData.find(d => d.year===selectedYear && d.monthIndex===selectedMonthIndex); 
                const initialDetails = r ? Object.keys(r.details).reduce((acc, key) => { acc[key] = String(r.details[key]); return acc; }, {}) : {};
                setFormData(initialDetails); 
            }, [selectedYear, selectedMonthIndex]);

            useEffect(() => { 
                if (balanceSnapshots[balanceDate]) { setCurrentSnapshot(balanceSnapshots[balanceDate]); }
                else { setCurrentSnapshot(prev => ({ ...prev, prices: prev.prices || {}, benchmarkNav: '', cash: '', condoPriceSqm: '', landPrice: '', goldPrice: '', creditCardDebt: '', condoLoanDebt: '' })); }
            }, [balanceDate, balanceSnapshots]);

            const addNextYear = () => setMaxYear(prev => prev + 1);
            
            const handleBudgetInput = (cat, val) => { 
                const cleanVal = cleanNumericInput(val);
                setFormData(prev => ({...prev, [cat]: cleanVal})); 
            };

            const saveBudgetToHistory = () => {
                const getNumericValue = (key) => parseFloat(formData[key]) || 0;
                const inc = FORM_CATEGORIES.income.reduce((s,k)=>s+getNumericValue(k),0); 
                const exp = FORM_CATEGORIES.expense.reduce((s,k)=>s+getNumericValue(k),0); 
                const sav = FORM_CATEGORIES.savings.reduce((s,k)=>s+getNumericValue(k),0); 
                const updatedDetails = Object.keys(formData).reduce((acc, key) => { acc[key] = getNumericValue(key); return acc; }, {});
                setHistoricalData(prev => prev.map(d => {
                    if (d.year===selectedYear && d.monthIndex===selectedMonthIndex) {
                        return {...d, details: updatedDetails, income: inc, expense: exp, savings: sav};
                    }
                    return d;
                }));
            };

            const handleTradeChange = (f, v) => { 
                let n = { ...tradeForm }; 
                if (f === 'amount' || f === 'price' || f === 'total') { n[f] = cleanNumericInput(v); } else { n[f] = v; }
                if (f === 'assetType') { if (v === 'gold') n.symbol = 'ทองคำ'; if (v === 'gpf') n.symbol = 'กบข.'; }
                if (n.assetType !== 'gpf') { 
                    const a = parseFloat(n.amount) || 0; const p = parseFloat(n.price) || 0; const t = parseFloat(n.total) || 0; 
                    if ((f === 'amount' || f === 'price') && !isNaN(a) && !isNaN(p)) { n.total = (a * p).toFixed(2); } 
                    else if ((f === 'total' || f === 'amount') && !isNaN(a) && a !== 0 && !isNaN(t)) { n.price = (t / a).toFixed(4); } 
                } 
                setTradeForm(n); 
            };

            const addTrade = () => { 
                if(!tradeForm.symbol) return alert('ระบุ Symbol'); 
                const t = { id: Date.now(), ...tradeForm, amount: tradeForm.assetType==='gpf'?0:Number(parseFloat(tradeForm.amount) || 0), price: tradeForm.assetType==='gpf'?0:Number(parseFloat(tradeForm.price) || 0), total: Number(parseFloat(tradeForm.total) || 0) }; 
                setTrades([...trades, t]); setTradeForm({...tradeForm, amount:'', price:'', total:''}); 
            };
            
            const deleteTrade = (id) => { if(confirm('ลบรายการ?')) setTrades(trades.filter(t=>t.id!==id)); };
            
            const saveSnapshot = () => { 
                const snapshotToSave = {};
                for(const key in currentSnapshot) {
                    if (key === 'prices' && currentSnapshot.prices) { snapshotToSave.prices = Object.keys(currentSnapshot.prices).reduce((acc, sym) => { acc[sym] = parseFloat(currentSnapshot.prices[sym]) || 0; return acc; }, {}); }
                    else if (typeof currentSnapshot[key] === 'string' && key !== 'balanceDate') { snapshotToSave[key] = parseFloat(currentSnapshot[key]) || 0; }
                    else { snapshotToSave[key] = currentSnapshot[key]; }
                }
                setBalanceSnapshots({...balanceSnapshots, [balanceDate]: snapshotToSave}); alert('บันทึกเรียบร้อย'); 
            };
            
            const handleSnap = (f, v, sub) => {
                const cleanVal = cleanNumericInput(v);
                if (sub) { setCurrentSnapshot(p => ({ ...p, [f]: { ...p[f], [sub]: cleanVal } })); } 
                else { setCurrentSnapshot(p => ({ ...p, [f]: cleanVal })); }
            };

            // Add this function inside FinanceDashboard
            const getCurrentSnapValue = (field, sub=null) => {
                let val;
                if (sub) {
                    val = currentSnapshot[field]?.[sub];
                } else {
                    val = currentSnapshot[field];
                }
                return val !== undefined && val !== null ? String(val) : '';
            };


            const getHoldings = useCallback((date) => {
                const limit = new Date(date); const map = {};
                trades.forEach(t => { if (new Date(t.date) <= limit) { if (!map[t.symbol]) map[t.symbol] = { qty: 0, type: t.assetType }; if (t.type !== 'gpf') { if (t.type === 'buy') map[t.symbol].qty += t.amount; else if (t.type === 'sell' || t.type === 'sell_all') map[t.symbol].qty -= t.amount; } } });
                return map;
            }, [trades]);

            const sellAll = () => {
                if(!tradeForm.symbol || !tradeForm.date) return alert('กรุณาระบุวันที่และ Symbol');
                const holdings = getHoldings(tradeForm.date);
                const currentQty = holdings[tradeForm.symbol]?.qty || 0;
                if(currentQty <= 0) return alert('ไม่มีจำนวนหน่วยคงเหลือให้ขาย');
                setTradeForm(prev => ({...prev, amount: String(currentQty), type: 'sell_all'}));
            };

            const calcAssets = (snap, date) => {
                const parseSnapValue = (val) => parseFloat(String(val)) || 0;
                if (!snap) return { totalInv: 0, list: [], totalAssets: 0, totalLiab: 0, liquid:0, personal:0, investment:0, debtShort:0, debtLong:0 };
                
                const checkDate = new Date(date);
                const condoStartDate = new Date('2023-12-01');
                const hasCondo = checkDate >= condoStartDate;

                const holdings = getHoldings(date);
                let invTotal = 0, invList = [];
                Object.keys(holdings).forEach(sym => {
                    const type = holdings[sym].type; const qty = snap.assetQuantities?.[sym] ?? holdings[sym].qty; 
                    let price = type === 'gold' ? parseSnapValue(snap.goldPrice) : parseSnapValue(snap.prices?.[sym]); 
                    const val = qty * price; if(val > 0) { invTotal += val; invList.push({ name: sym, value: val, type }); }
                });
                const landVal = 1130 * parseSnapValue(snap.landPrice); if (landVal > 0) { invTotal += landVal; invList.push({ name: 'อสังหาฯ', value: landVal, type:'land' }); }
                const lifeVal = calculateLifeInsuranceValue(new Date(date)); if (lifeVal > 0) { invTotal += lifeVal; invList.push({ name: 'ประกันชีวิต', value: lifeVal, type:'ins' }); }
                const ssVal = 12600; invTotal += ssVal; invList.push({ name: 'ประกันสังคม', value: ssVal, type:'ss' });
                const liquid = parseSnapValue(snap.cash);
                const personal = hasCondo ? (parseSnapValue(snap.condoPriceSqm) * 33.36) : 0;
                const debtShort = parseSnapValue(snap.creditCardDebt);
                const debtLong = hasCondo ? parseSnapValue(snap.condoLoanDebt) : 0;
                return { liquid, personal, investment: invTotal, totalInv: invTotal, list: invList.sort((a,b)=>b.value-a.value), totalAssets: liquid + personal + invTotal, debtShort, debtLong, totalLiab: debtShort + debtLong };
            };

            const lastDayOfMonth = new Date(selectedYear, selectedMonthIndex + 1, 0).getDate();
            const overviewDateStr = `${selectedYear}-${String(selectedMonthIndex+1).padStart(2,'0')}-${lastDayOfMonth}`;
            const availDates = Object.keys(balanceSnapshots).sort();
            const snapDate = availDates.filter(d => d <= overviewDateStr).pop() || availDates[availDates.length-1];
            const snapData = balanceSnapshots[snapDate];
            const overviewCalc = calcAssets(snapData, snapDate || new Date().toISOString());
            const netWorth = overviewCalc.totalAssets - overviewCalc.totalLiab;

            // FIX: Variable name changed from currentHoldings to holdings to match prop usage
            const holdings = getHoldings(balanceDate);
            const activeSymbols = Object.keys(holdings).filter(s => holdings[s].qty > 0).sort();
            const grouped = { gpf:[], mutual_fund:[], stock:[], bond:[], gold: [] };
            activeSymbols.forEach(s => { 
                const t = holdings[s].type; 
                if(grouped[t]) grouped[t].push(s); 
            });
            const totalPortValue = activeSymbols.reduce((sum, sym) => { 
                let price = 0; 
                const type = holdings[sym].type; 
                if(type==='gold') price = parseFloat(currentSnapshot.goldPrice)||0; 
                else price = parseFloat(currentSnapshot.prices?.[sym])||0; 
                return sum + (holdings[sym].qty * price); 
            }, 0);
            
            const balanceSheetCalc = calcAssets(currentSnapshot, balanceDate);

            const calculateMockIRR = () => { return 7.5; };
            const currentIRR = calculateMockIRR();

            const cards = [ { label: 'ความมั่งคั่งสุทธิ', val: netWorth, color: 'text-primary', b:'border-primary' }, { label: 'สินทรัพย์รวม', val: overviewCalc.totalAssets, color: 'text-secondary', b:'border-secondary' }, { label: 'หนี้สินรวม', val: overviewCalc.totalLiab, color: 'text-alert', b:'border-alert' }, { label: 'เงินสดคงเหลือ', val: overviewCalc.liquid, color: 'text-slate-600', b:'border-slate-300' } ];
            const combinedAssetsData = useMemo(() => {
                const grouped = {};
                const holdings = getHoldings(snapDate || new Date().toISOString());
                overviewCalc.list.forEach(i => { let label = ASSET_TYPE_LABELS[i.type] || 'อื่นๆ'; if(i.type === 'gpf') label = 'กบข.'; else if(i.type === 'mutual_fund') label = 'กองทุนรวม'; else if(i.type === 'stock') label = 'หุ้น/ETF'; else if(i.type === 'bond') label = 'ตราสารหนี้/พันธบัตร'; else if(i.type === 'gold') label = 'ทองคำ'; else if(i.type === 'ss') label = 'ประกันสังคม'; else if(i.type === 'ins') label = 'ประกันชีวิต'; else if(i.type === 'land') label = 'อสังหาฯ'; grouped[label] = (grouped[label] || 0) + i.value; });
                if(overviewCalc.liquid > 0) grouped['เงินสด'] = overviewCalc.liquid; if(overviewCalc.personal > 0) grouped['อสังหาฯส่วนตัว'] = overviewCalc.personal; 
                let list = Object.keys(grouped).map(k => ({name: k, value: grouped[k]})).filter(i => i.value > 0).sort((a,b)=>b.value-a.value);
                if (list.length > 5) { const top5 = list.slice(0, 5); const others = list.slice(5).reduce((s,i) => s + i.value, 0); list = [...top5, { name: 'สินทรัพย์อื่น ๆ', value: others }]; }
                return list;
            }, [overviewCalc]);

            const graphStartDate = '2016-10-01'; const validGraphDates = availDates.filter(d => d >= graphStartDate && d <= overviewDateStr);
            const baseNavForMock = parseFloat(balanceSnapshots[snapDate]?.benchmarkNav) || 15; 
            const benchmarkData = validGraphDates.map((d, i) => { 
                const dateObj = new Date(d);
                const years = (dateObj - new Date(graphStartDate)) / (1000 * 60 * 60 * 24 * 365);
                const initialMockVal = overviewCalc.totalAssets / 3; 
                const mockBenchmarkVal = initialMockVal * Math.pow(1 + 0.06, years);
                return { date: dateObj.toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'2-digit'}), benchmarkVal: mockBenchmarkVal };
            });
            const graphData = validGraphDates.map((d, i) => { const c = calcAssets(balanceSnapshots[d], d); const metric = c.investment + c.liquid + c.ss + c.ins + c.land + c.personal; return { date: new Date(d).toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'2-digit'}), val: metric }; });
            const combinedGraphData = graphData.map((d, i) => ({ ...d, benchmarkVal: benchmarkData[i]?.benchmarkVal }));

            const cashFlowData = historicalData.filter(d => { const selDate = new Date(selectedYear, selectedMonthIndex, 1); const diff = (selDate - d.dateObj)/(1000*60*60*24*30); return diff >= 0 && diff < cashFlowRange*12; }).sort((a,b)=>a.dateObj-b.dateObj).map(d => ({ name: d.axisLabel, income: d.income, expense: d.expense }));
            const expPieData = FORM_CATEGORIES.expense.map(c => ({ name: c, value: parseFloat(formData[c])||0 })).filter(d=>d.value>0).sort((a,b)=>b.value-a.value); const top5Exp = expPieData.slice(0, 5); if (expPieData.length > 5) top5Exp.push({ name: 'ค่าใช้จ่ายอื่น ๆ', value: expPieData.slice(5).reduce((s,i)=>s+i.value,0) }); const totalExp = expPieData.reduce((s,i)=>s+i.value,0);
            const getAnnRet = (yrs) => { if (validGraphDates.length < 2) return 0; const targetD = new Date(overviewDateStr); targetD.setFullYear(targetD.getFullYear() - yrs); const dStr = targetD.toISOString().split('T')[0]; const pastD = validGraphDates.filter(d => d <= dStr).pop(); if (!pastD) return 0; const pastC = calcAssets(balanceSnapshots[pastD], pastD); const pastVal = pastC.investment + pastC.liquid + pastC.ss + pastC.ins + pastC.land + pastC.personal; const currVal = overviewCalc.investment + overviewCalc.liquid + overviewCalc.ss + overviewCalc.ins + overviewCalc.land + overviewCalc.personal; if(pastVal <= 0) return 0; return (Math.pow(currVal/pastVal, 1/yrs) - 1) * 100; };
            const getBudgetAvg = (category, yearsBack) => { const monthsBack = yearsBack * 12; const now = new Date(selectedYear, selectedMonthIndex, 1); const relevantData = historicalData.filter(d => { const diff = (now - d.dateObj) / (1000*60*60*24*30); return diff >= 0 && diff < monthsBack; }); if(relevantData.length === 0) return 0; return relevantData.reduce((acc, d) => acc + (parseFloat(d.details[category]) || 0), 0) / relevantData.length; };
            const renderDonutListContent = (data, totalValue, totalColorClass) => ( <div className="h-full flex flex-col pt-6"><div className="flex-1 overflow-y-auto no-scrollbar pr-1 flex flex-col gap-2 text-sm">{data.map((e, i) => (<div key={i} className="flex justify-between items-center py-0.5 border-b border-slate-50"><div className="flex items-center gap-1"><div className="w-1.5 h-1.5 rounded-full" style={{ backgroundColor: COLORS_MAIN[i % COLORS_MAIN.length] }}></div><span className="truncate flex-1 font-medium text-slate-600">{e.name}</span></div><div className="flex items-center gap-3 font-bold text-sm"><span className="text-slate-700 w-16 text-right">{formatNumber(e.value, 0)}</span><span className={`${totalColorClass} w-10 text-right`}>{((e.value / totalValue) * 100).toFixed(1)}%</span></div></div>))}</div><div className="flex justify-between items-center pt-2 mt-2 border-t border-slate-200"><span className="font-bold text-slate-800 text-base">รวม</span><span className={`text-lg font-extrabold ${totalColorClass}`}>{formatNumber(totalValue, 0)}</span></div></div> );
            const renderAssetList = renderDonutListContent(combinedAssetsData, overviewCalc.totalAssets, 'text-primary');
            const renderExpenseList = renderDonutListContent(top5Exp, totalExp, 'text-alert');
            const totalInc = FORM_CATEGORIES.income.reduce((s,k)=>s+(parseFloat(formData[k])||0),0); const totalSav = FORM_CATEGORIES.savings.reduce((s,k)=>s+(parseFloat(formData[k])||0),0); const net = totalInc - totalExp - totalSav;
            
            // --- Sync Settings Handler ---
            const handleSyncSettings = () => {
                const url = prompt("กรุณากรอก Google Apps Script Web App URL:", apiUrl);
                if (url !== null) setApiUrl(url);
            };

            const handleExport = () => {
                const data = {
                    historicalData,
                    trades,
                    balanceSnapshots
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `myfinance_backup_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
            };

            const handleImportClick = () => {
                fileInputRef.current.click();
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.historicalData && data.trades && data.balanceSnapshots) {
                            setHistoricalData(data.historicalData);
                            setTrades(data.trades);
                            setBalanceSnapshots(data.balanceSnapshots);
                            alert('Import Successful!');
                        } else {
                            alert('Invalid file format');
                        }
                    } catch (err) {
                        alert('Error importing file');
                    }
                };
                reader.readAsText(file);
            };


            return (
                <div className="w-full max-w-[1600px] mx-auto h-full flex flex-col">
                    <div className="flex justify-between items-center bg-white px-6 py-4 shadow-sm z-40 shrink-0">
                        <div className="flex items-center gap-8">
                            <div className="flex items-center gap-3 text-primary font-black text-2xl tracking-tighter"><Icons.Wallet size={32}/> MyFinance <span className="text-secondary font-light">V3.4</span></div>
                            <div className="flex gap-2 bg-slate-100 p-1 rounded-lg">{[{id:'dashboard', l:'Dashboard'}, {id:'transactions', l:'Transactions'}, {id:'portfolio', l:'Portfolio'}, {id:'balance', l:'Balance Sheet'}].map(t=>(<button key={t.id} onClick={()=>setActiveTab(t.id)} className={`hidden lg:block px-6 py-2 rounded-md text-sm font-bold transition-all ${activeTab===t.id?'bg-white shadow text-primary':'text-slate-500 hover:text-slate-800'}`}>{t.l}</button>))}</div>
                        </div>
                        <div className="flex items-center gap-3 w-full lg:w-auto justify-end">
                             {/* Mobile Menu Dropdown */}
                            <div className="lg:hidden w-full max-w-[150px] mr-auto">
                                <select 
                                    value={activeTab} 
                                    onChange={(e) => setActiveTab(e.target.value)}
                                    className="w-full bg-slate-100 border-none rounded-lg font-bold text-slate-700 py-2 px-3 focus:ring-2 focus:ring-primary text-xs"
                                >
                                    <option value="dashboard">Dashboard</option>
                                    <option value="transactions">Transactions</option>
                                    <option value="portfolio">Portfolio</option>
                                    <option value="balance">Balance Sheet</option>
                                </select>
                            </div>

                            <div className="flex items-center mr-2">
                                {syncStatus === 'syncing' && <Icons.RefreshCw className="animate-spin text-blue-500" size={18}/>}
                                {syncStatus === 'synced' && <Icons.Cloud className="text-green-500" size={18}/>}
                                {syncStatus === 'error' && <Icons.Cloud className="text-red-500" size={18}/>}
                                {syncStatus === 'offline' && <Icons.Cloud className="text-slate-300" size={18}/>}
                            </div>
                            <button onClick={handleSyncSettings} className="text-slate-400 hover:text-primary transition-colors p-1" title="API Settings"><Icons.Settings size={20}/></button>
                            <button onClick={handleExport} className="text-slate-500 hover:text-primary transition-colors p-1" title="Backup Data"><Icons.Download size={20}/></button>
                            <button onClick={handleImportClick} className="text-slate-500 hover:text-primary transition-colors p-1" title="Restore Data"><Icons.Upload size={20}/></button>
                            <input type="file" ref={fileInputRef} onChange={handleImport} style={{display:'none'}} accept=".json" />
                            <div className="h-6 w-px bg-slate-200 mx-1"></div>
                            <select value={selectedMonthIndex} onChange={e=>setSelectedMonthIndex(Number(e.target.value))} className="bg-slate-50 border-none rounded-lg font-bold text-slate-700 px-2 lg:px-4 cursor-pointer focus:ring-2 focus:ring-primary top-control text-xs lg:text-sm">{MONTHS.map((m,i)=><option key={i} value={i}>{m}</option>)}</select>
                            <div className="flex items-center"><select value={selectedYear} onChange={e=>setSelectedYear(Number(e.target.value))} className="bg-slate-50 border-none rounded-l-lg font-bold text-slate-700 px-2 lg:px-4 cursor-pointer focus:ring-2 focus:ring-primary top-control text-xs lg:text-sm">{[...Array(maxYear-START_YEAR+1)].map((_,i)=><option key={i} value={START_YEAR+i}>{START_YEAR+i+543}</option>)}</select><button onClick={addNextYear} className="bg-slate-200 hover:bg-slate-300 text-slate-600 px-2 rounded-r-lg top-control-button"><Icons.Plus size={16} className="lg:w-5 lg:h-5"/></button></div>
                        </div>
                    </div>
                    <div className="flex-1 min-h-0 bg-bg relative">
                        {activeTab === 'dashboard' && <DashboardView {...{ combinedAssetsData, graphData, top5Exp, overviewCalc, totalExp, getAnnRet, renderAssetList, renderExpenseList, cards, cashFlowData, setCashFlowRange, cashFlowRange, combinedGraphData, currentIRR }} />}
                        {activeTab === 'transactions' && <TransactionsView {...{ formData, handleBudgetInput, saveBudgetToHistory, getBudgetAvg, budgetAvgRange, setBudgetAvgRange, allCategories: TRANSACTION_CATEGORIES, totalInc, totalExp, totalSav, net }} />}
                        {activeTab === 'portfolio' && <PortfolioView {...{ tradeForm, handleTradeChange, activeSymbols, totalPortValue, trades, ASSET_TYPES, ASSET_TYPE_LABELS, addTrade, deleteTrade, sellAll }} />}
                        {activeTab === 'balance' && <BalanceSheetView {...{ currentSnapshot, handleSnap, balanceDate, setBalanceDate, saveSnapshot, holdings, grouped, calculateLifeInsuranceValue, getHoldings, getCurrentSnapValue, overviewCalc: balanceSheetCalc }} />}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FinanceDashboard />);
    </script>
</body>
</html>